#!/usr/bin/env python3

import time
import o80
import pam_mujoco
import o80_pam
import sys
import logging
import shared_memory
import signal_handler
from lightargs import BrightArgs,Set,Range,Positive,FileExists


def _get_handle(mujoco_id,
                segment_id_robot,
                segment_id_ball,
                segment_id_goal,
                segment_id_hit_point):
    robot = pam_mujoco.MujocoRobot(segment_id_robot,
                                   control=pam_mujoco.MujocoRobot.JOINT_CONTROL)
    ball = pam_mujoco.MujocoItem(segment_id_ball,
                                 control=pam_mujoco.MujocoItem.CONSTANT_CONTROL)
    goal = pam_mujoco.MujocoItem(segment_id_goal,
                                 control=pam_mujoco.MujocoItem.CONSTANT_CONTROL)
    hit_point = pam_mujoco.MujocoItem(segment_id_hit_point,
                                      control=pam_mujoco.MujocoItem.CONSTANT_CONTROL)
    handle = pam_mujoco.MujocoHandle(mujoco_id,
                                     table=True,
                                     robot1=robot,
                                     balls=(ball,),
                                     goals=(goal,),
                                     hit_points=(hit_point,))
    return handle
    

def _execute_visualization(config):

    handle_to = _get_handle(config.mujoco_id_to,
                            config.mujoco_id_to+config.segment_id_robot,
                            config.mujoco_id_to+config.segment_id_ball,
                            config.mujoco_id_to+config.segment_id_goal,
                            config.mujoco_id_to+config.segment_id_hit_point)
    
    handle_from = pam_mujoco.MujocoHandle(config.mujoco_id_from,
                                          read_only=True)

    robot_get = handle_from.interfaces[config.segment_id_robot]
    robot_set = handle_to.interfaces[config.mujoco_id_to+config.segment_id_robot]

    ball_get = handle_from.interfaces[config.segment_id_ball]
    ball_set = handle_to.interfaces[config.mujoco_id_to+config.segment_id_ball]

    goal_get = handle_from.interfaces[config.segment_id_goal]
    goal_set = handle_to.interfaces[config.mujoco_id_to+config.segment_id_goal]

    hit_point_get = handle_from.interfaces[config.segment_id_hit_point]
    hit_point_set = handle_to.interfaces[config.mujoco_id_to+config.segment_id_hit_point]

    # running at 400 hz
    frequency_manager = o80.FrequencyManager(400)

    signal_handler.init()
    while not signal_handler.has_received_sigint():
        
        ball_position,ball_velocity = ball_get.get()
        ball_set.set(ball_position,ball_velocity,duration_ms=50)

        goal_position,goal_velocity = goal_get.get()
        goal_set.set(goal_position,goal_velocity,duration_ms=50)

        hit_point_position,hit_point_velocity = hit_point_get.get()
        hit_point_set.set(hit_point_position,hit_point_velocity,duration_ms=50)

        joint_positions,joint_velocities = robot_get.get()
        robot_set.set(joint_positions,joint_velocities,duration_ms=50)

        frequency_manager.wait()
            
    handle_to.mujoco_exit()


def _configure():
    config = BrightArgs("pam mujoco visualization: graphics for an instance of pam_mujoco")
    config.add_option("mujoco_id_from",
                      "simulation",
                      "mujoco id of the pam_mujoco instance to represent ",
                      str)
    config.add_option("mujoco_id_to",
                      "visualization",
                      "mujoco id of the mujoco simulation spawned for visualization",
                      str)
    config.add_option("segment_id_robot",
                      "robot",
                      "segment_id of the robot controller to represent",
                      str)
    config.add_option("segment_id_ball",
                      "ball",
                      "segment_id of the ball controller to represent",
                      str)
    config.add_option("segment_id_goal",
                      "goal",
                      "segment_id of the goal controller to represent",
                      str)
    config.add_option("segment_id_hit_point",
                      "hit_point",
                      "segment_id of the hit point controller to represent",
                      str)

    change_all = False
    finished = config.dialog(change_all,sys.argv[1:])
    print()
    if finished:
        return config
    return None


def execute():

    config = _configure()

    if config is None:
        print()
        return
    
    _execute_visualization(config)

    print()

    
if __name__ == "__main__":

    execute()
